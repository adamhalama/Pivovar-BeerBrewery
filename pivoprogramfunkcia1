

#define  BUFSIZE  128

#define LedPin0 0
#define LedPin1 1
#define LedPin2 2
#define LedPin3 3
#define ButtonPin 4

#define BuzzPin 5
//#define BuzzPin 1


#include <lcd.h>


#define LCD_RS  25               //Register select pin
#define LCD_E   24               //Enable Pin
#define LCD_D4  23               //Data pin 4
#define LCD_D5  22               //Data pin 5
#define LCD_D6  21               //Data pin 6
#define LCD_D7  14

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <stdlib.h>
#include <wiringPi.h>

#include <time.h>

int zahriev(int t, int lcd;);
int udrztSlad(int t, int c, int Tx,int Txi, int vysladzStarttime, int lcd;);
int udrztChmel(int t, int c, int lcd;);
int peepanieSlad(int lcd;);
int peepanieChmel(int lcd;);
float teplota(float temp);


int main(void)
{
	time_t seconds;

    int vysladzStarttime;
    int starttime;
    //tx teplota v stupnoch C
    //cx cas v minutach

    int t1=24, c1=1;
    int t2=25, c2=1;
    int t3=26, c3=1;
    int t4=27, c4=1;

    int cht1=26, chc1=1;
    int cht2=100, chc2=1;
    int cht3=100, chc3=1;
    int cht4=100, chc4=1;
    int cht5=100, chc5=1;

    int Tx=c1+c2+c3+c4;
    int Txi=1;

    int lcd;



        	if(wiringPiSetup() == -1){ //when initialize wiring failed,print messageto screen
            printf("setup wiringPi failed !");
            return 1;
    }
            printf("linker LedPin0 : GPIO %d(wiringPi pin)\n",LedPin0); //when initialize wiring successfully,print message to screen
            printf("linker LedPin1 : GPIO %d(wiringPi pin)\n",LedPin1);
            printf("linker LedPin2 : GPIO %d(wiringPi pin)\n",LedPin2);
            printf("linker LedPin3 : GPIO %d(wiringPi pin)\n",LedPin3);

            pinMode(LedPin0, OUTPUT);
            pinMode(LedPin1, OUTPUT);
            pinMode(LedPin2, OUTPUT);
            pinMode(LedPin3, OUTPUT);
            pinMode(BuzzPin, OUTPUT);
            pinMode(ButtonPin, INPUT);

            pullUpDnControl(ButtonPin, PUD_UP);

            lcd = lcdInit (4, 20, 4, LCD_RS, LCD_E, LCD_D4, LCD_D5, LCD_D6, LCD_D7, 0, 0, 0, 0);


    seconds = time(NULL);
    starttime=seconds;
    printf("startovne sekundy: %d\n", starttime);

zahriev(t1, lcd);

peepanieSlad(lcd);

seconds = time(NULL);
vysladzStarttime=seconds;

Txi=udrztSlad(t1,c1,Tx,Txi, vysladzStarttime, lcd);

zahriev(t2, lcd);

Txi=udrztSlad(t2,c2,Tx,Txi, vysladzStarttime, lcd);
printf("som tu 105\n");
zahriev(t3, lcd);

Txi=udrztSlad(t3,c3,Tx,Txi, vysladzStarttime, lcd);
printf("som tu 109\n");
zahriev(t4, lcd);
printf("som tu 111\n");
Txi=udrztSlad(t4,c4,Tx,Txi ,vysladzStarttime, lcd); //koniec vysladzania
printf("som tu 113\n");
zahriev(cht1, lcd);
printf("som tu 115\n");
udrztChmel(cht1, chc1, lcd);

zahriev(cht2, lcd);

udrztChmel(cht2, chc2, lcd);

zahriev(cht3, lcd);

udrztChmel(cht3, chc3, lcd);

zahriev(cht4, lcd);

udrztChmel(cht4, chc4, lcd);

zahriev(cht5, lcd);

udrztChmel(cht5, chc5, lcd);

return 0;


} //koniec main

float teplota(float temp){


	int i, j;
	int fd;
	int ret;
	char buf[BUFSIZE];
	char tempBuf[5];


		fd = open("/sys/bus/w1/devices/28-020f9177242c/w1_slave", O_RDONLY);


		if(-1 == fd){
			perror("open device file error");
			return 1;
		}

		while(1){
			ret = read(fd, buf, BUFSIZE);
			if(0 == ret){
				break;
			}
			if(-1 == ret){
				if(errno == EINTR){
					continue;
				}
				perror("read()");
				close(fd);
				return 1;
			}}

		for(i=0;i<sizeof(buf);i++){
			if(buf[i] == 't'){
				for(j=0;j<sizeof(tempBuf);j++){
					tempBuf[j] = buf[i+2+j];
				}}}

		temp = (float)atoi(tempBuf) /1000 ;

            printf("%.3f C\n",temp);
		close(fd);

		printf("som tu 171\n");
		return temp;

}

int zahriev(int t, int lcd){

    float temp;

    int x=1;





    	printf("som tu 201 zahriev\n");

x=1;
	while(x == 1){ //stupanie na zaciatocnu teplotu t1=======================================================================================================================

	printf("som tu 206 zahriev\n");
	temp=teplota(temp);


    lcdPosition(lcd, 0, 0);
    lcdPrintf(lcd, "%.1f C", temp);

   if (temp<100){

    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, "-->");
    delay(150);} //ak je teplota vyssia ako 100 tak sa zaciatok sipky posuva o jedno

    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, " -->");
    delay(150);
    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, "  -->");
    delay(150);
    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, "   -->");
    delay(150);
    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, "    -->");
    delay(150);
    if (t<100){
    lcdPosition(lcd, 6, 0);
    lcdPrintf(lcd, "     -->");
    delay(200);
    lcdPosition(lcd, 11, 0);
    lcdPrintf(lcd, "   ");

    lcdPosition(lcd, 14, 0);
    lcdPrintf(lcd, "%d.0 C", t);}//print pozadovanej teploty ked je menia ako 100
    else {
    delay(200);
    lcdPosition(lcd, 10, 0);
    lcdPrintf(lcd, "   ");
    lcdPosition(lcd, 13, 0);
    lcdPrintf(lcd, "%d.0 C", t);}//print pozadovanej teploty ked je vacsia ako 100



    if(temp<t){
    digitalWrite(LedPin0, LOW); //led on
    digitalWrite(LedPin1, LOW);
    digitalWrite(LedPin2, LOW);
    digitalWrite(LedPin3, LOW);
            delay(100);

    }

    else {

    digitalWrite(LedPin0, HIGH); //led off
    digitalWrite(LedPin1, HIGH);
    digitalWrite(LedPin2, HIGH);
    digitalWrite(LedPin3, HIGH);
    delay(100);

        x=0;
    }
} //koniec while



    return 0;
} //koniec funkcie

int udrztSlad(int t, int c, int Tx,int Txi, int vysladzStarttime, int lcd){

    float temp;


    int x;


	time_t seconds;
    int nowtime;
    float dlzkavaru;
    int etapaStarttime;


    int inputSecond;
    int hours1,minutes1,seconds1;
    int remainingSeconds;
    int secondsInHour = 60 * 60;
    int secondsInMinute = 60;

    int TxHlas=Tx-0;

    printf("som tu 296 udrztSlad\n");





seconds = time(NULL);
etapaStarttime=seconds;
x=1;
    while(x == 1){ //while 3 t1=======================================================================================================================

			temp=teplota(temp);
printf("som tu 306 udrztSlad\n");
    delay(100);
    lcdPosition(lcd, 0, 0);
    delay(100);
    printf("som tu 311\n");
    lcdPrintf(lcd, "%.1f C", temp);
printf("som tu 309 udrztSlad\n");





    if (t>100){
    delay(200);
    lcdPosition(lcd, 13, 0);
    lcdPrintf(lcd, "%d.0 C", t);
    }//print pozadovanej teploty ked je vacsia ako 100

    else {
    delay(100);
    lcdPosition(lcd, 14, 0);
    lcdPrintf(lcd, "%d.0 C", t);
    }


    if(temp<t){
    digitalWrite(LedPin0, LOW); //led on
    digitalWrite(LedPin1, LOW);
            delay(100);

    }

    else{

    digitalWrite(LedPin0, HIGH); //led off
    digitalWrite(LedPin1, HIGH);
    delay(100);
    }


if(Txi == 1){
   //cas
   seconds = time(NULL);
    printf("aktualne sekundy: %ld\n", seconds);
    nowtime=seconds;

    dlzkavaru=nowtime-vysladzStarttime;



  inputSecond=dlzkavaru;

  hours1 = (inputSecond/secondsInHour);

  remainingSeconds = inputSecond - (hours1 * secondsInHour);
  minutes1 = remainingSeconds/secondsInMinute;

  remainingSeconds = remainingSeconds - (minutes1*secondsInMinute);
  seconds1 = remainingSeconds;
  dlzkavaru=dlzkavaru/60;

printf("\n %.3f \n", dlzkavaru);
printf("\n %d \n", TxHlas);
  if (dlzkavaru>=TxHlas){

    lcdPosition(lcd, 7, 2);
    lcdPrintf(lcd, "Priprav");
    lcdPosition(lcd, 1, 3);
    lcdPrintf(lcd, "vysladzovaciu vodu");
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on
delay(100);
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on
delay(100);
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on
sleep(1);
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on
delay(100);
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on
delay(100);
digitalWrite(BuzzPin, 1); //led on
delay(100);
digitalWrite(BuzzPin, 0); //led on

Txi=0;
printf("%d", Txi);

  }
}


   seconds = time(NULL);
    printf("aktualne sekundy: %ld\n", seconds);
    nowtime=seconds;

    dlzkavaru=nowtime-etapaStarttime;


  inputSecond=dlzkavaru;

  hours1 = (inputSecond/secondsInHour);

  remainingSeconds = inputSecond - (hours1 * secondsInHour);
  minutes1 = remainingSeconds/secondsInMinute;

  remainingSeconds = remainingSeconds - (minutes1*secondsInMinute);
  seconds1 = remainingSeconds;

  printf("cas od zaciatku t1:  %d:%d:%d\n",hours1,minutes1,seconds1);


lcdPosition(lcd, 0, 1);
lcdPrintf(lcd, "%d:%d:%d",hours1,minutes1,seconds1);

    inputSecond=c*60; //premenenie vstupneho casu teda konecneho casu etapy na sekundy
    hours1 = (inputSecond/secondsInHour);

    remainingSeconds = inputSecond - (hours1 * secondsInHour);
    minutes1 = remainingSeconds/secondsInMinute;

    remainingSeconds = remainingSeconds - (minutes1*secondsInMinute);
    seconds1 = remainingSeconds;
    lcdPosition(lcd, 14, 1);
    lcdPrintf(lcd, "%d:%d:%d",hours1,minutes1,seconds1);



//dlzkavaru v minutach
dlzkavaru=dlzkavaru/60;

if (dlzkavaru>=c){
	x=0;
	}



} //koniec while 3

    return Txi;
}

int udrztChmel(int t, int c, int lcd){

float temp;


    int x=1;


    time_t seconds;
    int nowtime;
    float dlzkavaru;
    int etapaStarttime;


    int inputSecond;
    int hours1,minutes1,seconds1;
    int remainingSeconds;
    int secondsInHour = 60 * 60;
    int secondsInMinute = 60;

    lcd = lcdInit (4 , 20, 4, LCD_RS, LCD_E, LCD_D4, LCD_D5, LCD_D6, LCD_D7, 0, 0, 0, 0);



peepanieChmel();

seconds = time(NULL);
etapaStarttime=seconds;
x=1;
    while(x == 1){ //while 3 t1=======================================================================================================================

			temp=teplota(temp);

    lcdPosition(lcd, 10, 0);
    lcdPrintf(lcd, "%.1f C", temp);

    if(temp<t){
    digitalWrite(LedPin0, LOW); //led on
    digitalWrite(LedPin1, LOW);
            delay(100);
    }

    else {

    digitalWrite(LedPin0, HIGH); //led off
    digitalWrite(LedPin1, HIGH);
    delay(100);
    }




   //cas
   seconds = time(NULL);
    printf("aktualne sekundy: %ld\n", seconds);
    nowtime=seconds;

    dlzkavaru=nowtime-etapaStarttime;


  inputSecond=dlzkavaru;

  hours1 = (inputSecond/secondsInHour);

  remainingSeconds = inputSecond - (hours1 * secondsInHour);
  minutes1 = remainingSeconds/secondsInMinute;

  remainingSeconds = remainingSeconds - (minutes1*secondsInMinute);
  seconds1 = remainingSeconds;

  printf("cas od zaciatku t1:  %d:%d:%d\n",hours1,minutes1,seconds1);



lcdPosition(lcd, 0, 0);
lcdPrintf(lcd, "%d:%d:%d",hours1,minutes1,seconds1);

//dlzkavaru v minutach
dlzkavaru=dlzkavaru/60;

if (dlzkavaru>=c){
	x=0;
	}



} //koniec while 3

    return 0;
}

int peepanieSlad(int lcd){
	int i;



    int x;



    pinMode(BuzzPin, OUTPUT);
    pinMode(ButtonPin, INPUT);

    printf("som tu 560\n");



    pullUpDnControl(ButtonPin, PUD_UP);
x=1;
    while(x == 1){ //while 2 potvdenie pridania sladu=======================================================================================================================


    lcdPosition(lcd, 1, 0);
    lcdPrintf(lcd, "Teplota dosiahnuta");
    lcdPosition(lcd, 4, 1);
    lcdPrintf(lcd, "pridaj  slad");
    lcdPosition(lcd, 5, 2);
    lcdPrintf(lcd, "a nasledne");
    lcdPosition(lcd, 3, 3);
    lcdPrintf(lcd, "stlac tlacidlo");

digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 1
delay(100);
for(i=1;i < 32767; i++){
if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 2
delay(100);
for(i=1;i < 32767; i++){
if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 3

for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
printf("som tu 564\n");
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){


if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);

printf("som tu 634\n");



printf("som tu 639\n");

} //koniec while 2

    return 0;
}

int peepanieChmel(int lcd){
	int i;



    int x;



    pinMode(BuzzPin, OUTPUT);
    pinMode(ButtonPin, INPUT);

    printf("som tu 725\n");



    pullUpDnControl(ButtonPin, PUD_UP);
x=1;
    while(x == 1){ //while 2 potvdenie pridania sladu=======================================================================================================================


    //lcdPosition(lcd, 4, 1);
    //lcdPrintf(lcd, "Cas uplynul");
    lcdPosition(lcd, 4, 2);
    lcdPrintf(lcd, "pridaj chmel");


digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 1
delay(100);
for(i=1;i < 32767; i++){
if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 2
delay(100);
for(i=1;i < 32767; i++){
if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 1); //led on
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

digitalWrite(BuzzPin, 0); //led off 3

for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}

for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){


if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);
for(i=1;i < 32767; i++){

if(digitalRead(ButtonPin) == 0)
{
x=0;
}}
delay(100);

printf("som tu 864\n");


} //koniec while 2




    return 0;
}

